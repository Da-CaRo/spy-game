<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juego de Esp√≠as - Tablero Digital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos personalizados para la tipograf√≠a del juego */
        .card-text {
            font-size: clamp(0.75rem, 3vw, 1.5rem);
            /* Tama√±o responsivo del texto */
            line-height: 1.2;
        }

        /* Colores de revelaci√≥n */
        .bg-red-agent {
            background-color: #dc2626;
            color: white;
        }

        /* Rojo-600 */
        .bg-blue-agent {
            background-color: #2563eb;
            color: white;
        }

        /* Azul-600 */
        .bg-neutral-agent {
            background-color: #f59e0b;
            color: white;
        }

        /* √Åmbar-500 */
        .bg-assassin {
            background-color: #1f2937;
            color: white;
        }

        /* Gris-800 */
    </style>
</head>

<body class="bg-gray-900 text-white p-4 sm:p-8 min-h-screen flex flex-col items-center">

    <header class="w-full max-w-6xl mb-4 text-center">
        <h1 class="text-4xl sm:text-5xl font-extrabold text-yellow-400 tracking-wider uppercase">
            Juego de Esp√≠as
        </h1>
    </header>

    <main class="w-full max-w-6xl">

        <div class="flex flex-col sm:flex-row justify-between items-center w-full mb-6">

            <div id="game-info"
                class="flex justify-between items-center w-full sm:w-auto text-xl sm:text-2xl font-semibold mb-4 sm:mb-0 space-x-4">
                <div id="blue-score" class="text-blue-400 bg-blue-900/50 p-2 rounded-lg whitespace-nowrap">
                    üîµ Azules: <span class="font-bold text-3xl">-</span>
                </div>
                <div id="current-turn" class="bg-gray-700 p-2 rounded-lg text-yellow-300 whitespace-nowrap">
                    Esperando inicio...
                </div>
                <div id="red-score" class="text-red-400 bg-red-900/50 p-2 rounded-lg whitespace-nowrap">
                    üî¥ Rojos: <span class="font-bold text-3xl">-</span>
                </div>
            </div>

            <div id="game-controls" class="flex space-x-4 w-full sm:w-auto justify-end">
                <button id="show-key-btn"
                    class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-full transition duration-150 text-xl w-full sm:w-auto shadow-lg hover:shadow-xl disabled:opacity-50 hidden">
                    üëÅÔ∏è Ver Clave Secreta
                </button>
                <button id="pass-turn-btn"
                    class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 px-6 rounded-full transition duration-150 text-xl w-full sm:w-auto shadow-lg hover:shadow-xl disabled:opacity-50 hidden">
                    Pasar Turno
                </button>
            </div>
        </div>

        <div id="start-buttons"
            class="flex flex-col sm:flex-row justify-center space-y-3 sm:space-y-0 sm:space-x-4 w-full">
            <button id="start-blue-btn"
                class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full transition duration-150 text-xl w-full sm:w-auto shadow-lg hover:shadow-xl">
                üîµ Empieza AZUL (9 Agentes)
            </button>
            <button id="start-random-btn"
                class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-full transition duration-150 text-xl w-full sm:w-auto shadow-lg hover:shadow-xl">
                üé≤ Empieza ALEATORIO
            </button>
            <button id="start-red-btn"
                class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-full transition duration-150 text-xl w-full sm:w-auto shadow-lg hover:shadow-xl">
                üî¥ Empieza ROJO (9 Agentes)
            </button>
        </div>

        <div id="game-board" class="grid grid-cols-5 gap-3 sm:gap-4 md:gap-5 w-full aspect-square">
        </div>
    </main>


    <script type="module">
        // Importar las palabras desde el archivo externo
        import { PALABRAS_SECRETAS } from './palabras.js';

        const TIPOS_CARTA = {
            ROJO: 'red',
            AZUL: 'blue',
            NEUTRAL: 'neutral',
            ASESINO: 'assassin',
            // Mapeo de tipos a emojis para la consola/alerta
            MAPEO_EMOJI: {
                'red': 'üî¥',
                'blue': 'üîµ',
                'neutral': 'üü°',
                'assassin': '‚ö´'
            },
            // Mapeo de tipos a las iniciales solicitadas para la codificaci√≥n
            MAPEO_CODIGO: {
                'red': 'R',
                'blue': 'B',
                'neutral': 'N',
                'assassin': 'A'
            },
            // Mapeo inverso de iniciales a tipos
            MAPEO_INVERSO: {
                'R': 'red',
                'B': 'blue',
                'N': 'neutral',
                'A': 'assassin'
            }
        };

        // Constante para la clave de almacenamiento
        const USADAS_STORAGE_KEY = 'juegoDeEspias_palabrasUsadas';
        const PALABRAS_MAPA = new Map(PALABRAS_SECRETAS.map(p => [p.id, p.palabra]));

        // --- VARIABLES DE ESTADO DEL JUEGO ---
        let tableroLogico = [];
        let juegoTerminado = false;
        let agentesRojosRestantes = 0;
        let agentesAzulesRestantes = 0;
        let turnoActual = TIPOS_CARTA.AZUL;
        // -------------------------------------

        /**
         * Actualiza los contadores de agentes y el turno inicial bas√°ndose en el tablero decodificado.
         * @param {Array} tablero - El tablero l√≥gico a analizar.
         */
        function actualizarContadoresDeTablero(tablero) {
            let rojosTotales = 0;
            let azulesTotales = 0;

            // Contar agentes totales y agentes restantes (los que NO est√°n revelados)
            tablero.forEach(card => {
                if (card.type === TIPOS_CARTA.ROJO) {
                    rojosTotales++;
                    if (card.revealed) agentesRojosRestantes--; // Si est√° revelada, resta del contador
                } else if (card.type === TIPOS_CARTA.AZUL) {
                    azulesTotales++;
                    if (card.revealed) agentesAzulesRestantes--; // Si est√° revelada, resta del contador
                }
            });

            // Resetear y recalcular los contadores de juego
            agentesRojosRestantes = tablero.filter(c => c.type === TIPOS_CARTA.ROJO && !c.revealed).length;
            agentesAzulesRestantes = tablero.filter(c => c.type === TIPOS_CARTA.AZUL && !c.revealed).length;

            // Determinar el turno inicial (el que ten√≠a 9 agentes al inicio)
            // Esto es m√°s complejo, un estado de partida ideal tambi√©n deber√≠a guardar el 'turnoActual'.
            // Por simplicidad, asumiremos que si hay m√°s cartas azules en total (9) que rojas (8),
            // el turno inicial fue azul, y viceversa.
            // **NOTA:** Para reanudar el estado exacto del turno, la codificaci√≥n deber√≠a guardar tambi√©n 'turnoActual'.
            const agentesRojosIniciales = tablero.filter(c => c.type === TIPOS_CARTA.ROJO).length;
            const agentesAzulesIniciales = tablero.filter(c => c.type === TIPOS_CARTA.AZUL).length;

            turnoActual = (agentesAzulesIniciales > agentesRojosIniciales) ? TIPOS_CARTA.AZUL : TIPOS_CARTA.ROJO;

            juegoTerminado = false; // Asumimos que no est√° terminado a menos que una carta asesina est√© revelada.
            if (tablero.find(c => c.type === TIPOS_CARTA.ASESINO && c.revealed)) {
                juegoTerminado = true;
            }

            // Verificar si alg√∫n equipo gan√≥ por conteo de agentes
            if (agentesAzulesRestantes === 0 || agentesRojosRestantes === 0) {
                juegoTerminado = true;
            }

            ocultarBotonesInicio();
            document.getElementById('pass-turn-btn').disabled = juegoTerminado;
            renderizarTablero(); // Redibuja el tablero, aplicando estilos a las cartas reveladas
            actualizarPuntuacion();
            actualizarIndicadorTurno();
            mostrarClaveEnConsola();
        }

        // =========================================================
        // RESTO DE FUNCIONES (Solo se muestra 'inicializarJuego' y 'DOMContentLoaded' con demos)
        // =========================================================

        function cargarIdsUsados() {
            const data = localStorage.getItem(USADAS_STORAGE_KEY);
            if (data) {
                const lista = JSON.parse(data);
                const ids = lista.map(item => item.id);
                return new Set(ids);
            }
            return new Set();
        }

        function guardarNuevosIds(nuevosIds) {
            const idsAnteriores = localStorage.getItem(USADAS_STORAGE_KEY);
            let listaCompleta = idsAnteriores ? JSON.parse(idsAnteriores) : [];

            const fechaActual = new Date().toISOString().slice(0, 10);

            const nuevosItems = nuevosIds.map(id => ({
                id: id,
                fecha: fechaActual
            }));

            const mapaIds = new Map();

            listaCompleta.forEach(item => mapaIds.set(item.id, item));
            nuevosItems.forEach(item => mapaIds.set(item.id, item));

            localStorage.setItem(USADAS_STORAGE_KEY, JSON.stringify(Array.from(mapaIds.values())));
        }


        /**
         * Funci√≥n que encapsula toda la l√≥gica para empezar una partida nueva.
         */
        function inicializarJuego(startingTeam) {
            // ... (L√≥gica de selecci√≥n de palabras, tipos y contadores) ...

            juegoTerminado = false;
            turnoActual = startingTeam;

            const firstTeam = startingTeam;
            const secondTeam = (firstTeam === TIPOS_CARTA.AZUL) ? TIPOS_CARTA.ROJO : TIPOS_CARTA.AZUL;

            const idsUsados = cargarIdsUsados();
            let palabrasCandidatas = PALABRAS_SECRETAS.filter(item => !idsUsados.has(item.id));

            if (palabrasCandidatas.length < 25) {
                console.warn("¬°Pocas palabras no usadas! Reiniciando la lista completa.");
                localStorage.removeItem(USADAS_STORAGE_KEY);
                palabrasCandidatas = PALABRAS_SECRETAS;
            }

            const palabrasMezcladas = shuffleArray(palabrasCandidatas).slice(0, 25);
            const idsPartidaActual = palabrasMezcladas.map(item => item.id);
            guardarNuevosIds(idsPartidaActual);

            const tipos = [
                ...Array(9).fill(firstTeam),
                ...Array(8).fill(secondTeam),
                ...Array(7).fill(TIPOS_CARTA.NEUTRAL),
                TIPOS_CARTA.ASESINO
            ];

            const tiposMezclados = shuffleArray(tipos);

            tableroLogico = palabrasMezcladas.map((item, index) => ({
                id: item.id,
                word: item.palabra,
                type: tiposMezclados[index],
                revealed: false
            }));

            agentesAzulesRestantes = (firstTeam === TIPOS_CARTA.AZUL) ? 9 : 8;
            agentesRojosRestantes = (firstTeam === TIPOS_CARTA.ROJO) ? 9 : 8;

            ocultarBotonesInicio();
            document.getElementById('pass-turn-btn').disabled = false;

            renderizarTablero();
            actualizarPuntuacion();
            actualizarIndicadorTurno();

            // Llama a la funci√≥n de consola y guarda el estado codificado en la consola.
            mostrarClaveEnConsola();
            // console.log("Cadena Codificada del Tablero:", codificarTablero()); // DESCOMENTAR PARA VER LA CADENA COMPLETA
        }

        // ... (Resto de funciones: mostrarClaveEnConsola, mostrarClaveEnAlerta, mostrarBotonesInicio, etc.) ...
        function mostrarClaveEnConsola() {
            if (!tableroLogico || tableroLogico.length !== 25) return;

            console.log("\n--- CLAVE SECRETA (PARA EL L√çDER DE ESP√çAS) ---");
            console.log("-----------------------------------------------");

            let claveConsola = "";
            for (let i = 0; i < 25; i++) {
                claveConsola += TIPOS_CARTA.MAPEO_EMOJI[tableroLogico[i].type];
                if ((i + 1) % 5 === 0) {
                    claveConsola += "\n";
                }
            }

            console.log(claveConsola);
            console.log("-----------------------------------------------\n");
        }

        function mostrarClaveEnAlerta() {
            if (!tableroLogico || tableroLogico.length !== 25) return;

            let claveAlerta = "CLAVE SECRETA (L√çDER DE ESP√çAS):\n\n";
            for (let i = 0; i < 25; i++) {
                claveAlerta += TIPOS_CARTA.MAPEO_EMOJI[tableroLogico[i].type];
                if ((i + 1) % 5 === 0) {
                    claveAlerta += "\n";
                }
            }

            alert(claveAlerta);
        }

        /**
         * Muestra los botones de inicio y oculta los controles del juego.
         */
        function mostrarBotonesInicio() {
            document.getElementById('start-buttons').classList.remove('hidden');
            document.getElementById('pass-turn-btn').classList.add('hidden');
            document.getElementById('show-key-btn').classList.add('hidden');

            document.getElementById('game-board').innerHTML = '<div class="text-center text-gray-400 text-3xl p-10 col-span-5">Selecciona el equipo que empieza para comenzar una nueva partida.</div>';

            document.getElementById('current-turn').innerHTML = 'Esperando inicio...';
            document.querySelector('#blue-score span').textContent = '-';
            document.querySelector('#red-score span').textContent = '-';
        }

        /**
         * Oculta los botones de inicio y muestra los controles del juego.
         */
        function ocultarBotonesInicio() {
            document.getElementById('start-buttons').classList.add('hidden');
            document.getElementById('pass-turn-btn').classList.remove('hidden');
            document.getElementById('show-key-btn').classList.remove('hidden');
        }


        /**
         * Cambia el turno al equipo contrario y actualiza el indicador en la interfaz.
         */
        function cambiarTurno() {
            if (juegoTerminado) return;

            turnoActual = (turnoActual === TIPOS_CARTA.AZUL) ? TIPOS_CARTA.ROJO : TIPOS_CARTA.AZUL;
            actualizarIndicadorTurno();
            console.log(`¬°Turno cambiado! Ahora es el turno del equipo ${turnoActual.toUpperCase()}.`);
        }

        /**
         * Actualiza el texto del turno en la interfaz.
         */
        function actualizarIndicadorTurno() {
            const color = (turnoActual === TIPOS_CARTA.AZUL) ? 'blue' : 'red';
            const textoTurno = (turnoActual === TIPOS_CARTA.AZUL) ? 'Azul üîµ' : 'Rojo üî¥';
            document.getElementById('current-turn').innerHTML = `Turno: <span class="text-${color}-400">${textoTurno}</span>`;
        }

        /**
         * Funci√≥n principal para manejar la l√≥gica al hacer click en una tarjeta.
         */
        function manejarClickTarjeta(event) {
            if (juegoTerminado) return;

            const cardDiv = event.currentTarget;
            const index = parseInt(cardDiv.getAttribute('data-index'));
            const cardData = tableroLogico[index];

            if (cardData.revealed) return;

            cardData.revealed = true;
            let cssClass = '';
            let finDeTurno = false;

            const equipoActual = turnoActual;

            switch (cardData.type) {
                case TIPOS_CARTA.ROJO:
                    cssClass = 'bg-red-agent';
                    agentesRojosRestantes--;
                    if (equipoActual === TIPOS_CARTA.AZUL) finDeTurno = true;
                    break;
                case TIPOS_CARTA.AZUL:
                    cssClass = 'bg-blue-agent';
                    agentesAzulesRestantes--;
                    if (equipoActual === TIPOS_CARTA.ROJO) finDeTurno = true;
                    break;
                case TIPOS_CARTA.NEUTRAL:
                    cssClass = 'bg-neutral-agent';
                    finDeTurno = true;
                    break;
                case TIPOS_CARTA.ASESINO:
                    cssClass = 'bg-assassin';
                    juegoTerminado = true;
                    break;
            }

            // Aplicar estilo de revelaci√≥n y remover clases de interacci√≥n
            cardDiv.className = `card ${cssClass} flex items-center justify-center p-1 sm:p-2 rounded-lg shadow-xl aspect-square`;
            cardDiv.classList.remove('cursor-pointer', 'hover:shadow-2xl', 'transition', 'duration-150', 'transform', 'hover:scale-[1.01]', 'bg-gray-200', 'text-gray-900');

            actualizarPuntuacion();

            // 1. Verificar si hay victoria o derrota por Asesino
            verificarFinJuego();

            // 2. Si no ha terminado, verificar si el turno debe cambiar autom√°ticamente
            if (!juegoTerminado && finDeTurno) {
                cambiarTurno();
            }
        }

        /**
         * Funci√≥n para mezclar un array (Fisher-Yates).
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        /**
         * Funci√≥n que inserta las tarjetas en el DOM y asigna eventos.
         */
        function renderizarTablero() {
            const board = document.getElementById('game-board');
            board.innerHTML = '';

            tableroLogico.forEach((card, index) => {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'card bg-gray-200 text-gray-900 flex items-center justify-center p-1 sm:p-2 rounded-lg shadow-xl cursor-pointer hover:shadow-2xl transition duration-150 transform hover:scale-[1.01] aspect-square';
                cardDiv.setAttribute('data-index', index);
                cardDiv.setAttribute('data-id', card.id);

                const textSpan = document.createElement('span');
                textSpan.className = 'card-text font-bold uppercase text-center';
                textSpan.textContent = card.word;

                cardDiv.appendChild(textSpan);
                board.appendChild(cardDiv);
            });

            // Asignar el Event Listener a todas las tarjetas
            document.querySelectorAll('.card').forEach(card => {
                card.addEventListener('click', manejarClickTarjeta);
            });
        }

        /**
         * Actualiza los contadores de agentes en la interfaz.
         */
        function actualizarPuntuacion() {
            document.querySelector('#blue-score span').textContent = agentesAzulesRestantes;
            document.querySelector('#red-score span').textContent = agentesRojosRestantes;
        }

        /**
         * Verifica las condiciones de victoria o derrota por conteo o por Asesino.
         * Establece juegoTerminado en true si se cumplen las condiciones.
         */
        function verificarFinJuego() {
            let victoria = false;
            let mensaje = '';

            // 1. Verificar victoria por conteo de agentes
            if (agentesAzulesRestantes === 0) {
                victoria = true;
                mensaje = '¬°<span class="text-blue-400 font-bold">VICTORIA AZUL</span>! üèÜ';
            } else if (agentesRojosRestantes === 0) {
                victoria = true;
                mensaje = '¬°<span class="text-red-400 font-bold">VICTORIA ROJA</span>! üèÜ';
            }

            // 2. Verificar derrota por Asesino (solo si no hay victoria por conteo)
            const asesinoRevelado = tableroLogico.some(card => card.type === TIPOS_CARTA.ASESINO && card.revealed);

            if (asesinoRevelado && !victoria) {
                juegoTerminado = true;
                const equipoGanador = (turnoActual === TIPOS_CARTA.AZUL) ? 'Rojo üî¥' : 'Azul üîµ';
                mensaje = `¬°JUEGO TERMINADO! <span class="text-red-500 font-bold">ASASINADO</span>. Gana: ${equipoGanador}`;
            } else if (victoria) {
                juegoTerminado = true;
            }


            // 3. Si el juego ha terminado, actualizar la UI
            if (juegoTerminado) {
                document.getElementById('pass-turn-btn').disabled = true;

                // Si el juego termin√≥ por asesino, el mensaje ya est√° establecido.
                // Si termin√≥ por victoria normal, el mensaje se establece arriba.
                document.getElementById('current-turn').innerHTML = mensaje;

                // Mostrar los botones de inicio despu√©s de que el juego termine
                setTimeout(mostrarBotonesInicio, 1500);
            }
        }

        // 4. Inicializar la p√°gina en estado de espera y asignar manejadores de eventos.
        document.addEventListener('DOMContentLoaded', () => {
            // Estado inicial: mostrar botones de inicio, ocultar tablero.
            mostrarBotonesInicio();

            // --- Manejadores para los nuevos botones de inicio ---

            // Empieza Azul
            document.getElementById('start-blue-btn').addEventListener('click', () => {
                inicializarJuego(TIPOS_CARTA.AZUL);
            });

            // Empieza Rojo
            document.getElementById('start-red-btn').addEventListener('click', () => {
                inicializarJuego(TIPOS_CARTA.ROJO);
            });

            // Empieza Aleatorio
            document.getElementById('start-random-btn').addEventListener('click', () => {
                const randomTeam = Math.random() < 0.5 ? TIPOS_CARTA.AZUL : TIPOS_CARTA.ROJO;
                inicializarJuego(randomTeam);
            });

            // Manejador para el bot√≥n "Pasar Turno"
            document.getElementById('pass-turn-btn').addEventListener('click', () => {
                if (!juegoTerminado) {
                    cambiarTurno();
                }
            });
        });
    </script>

</body>

</html>